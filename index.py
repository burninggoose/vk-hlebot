import vk_api
import random
import os
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
import atexit
import pyowm
from datetime import datetime
from coinmarketcap import Market
import re


def degree_to_text(degree):
    if (degree > 0.0 and degree <= 22.5):
        return '—Å–µ–≤–µ—Ä–Ω—ã–π'
    if (degree > 22.5 and degree <= 67.5):
        return '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π'
    if (degree > 67.5 and degree <= 112.5):
        return '–≤–æ—Å—Ç–æ—á–Ω—ã–π'
    if (degree > 112.5 and degree <= 157.5):
        return '—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π'
    if (degree > 157.5 and degree <= 202.5):
        return '—é–∂–Ω—ã–π'
    if (degree > 202.5 and degree <= 247.5):
        return '—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π'
    if (degree > 247.5 and degree <= 292.5):
        return '–∑–∞–ø–∞–¥–Ω—ã–π'
    if (degree > 292.5 and degree <= 337.5):
        return '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π'
    if (degree > 337.5 and degree <= 0.0):
        return '—Å–µ–≤–µ—Ä–Ω—ã–π'


def decide_emoji(percent):
    if (percent > 0):
        return 'üìà'
    return 'üìâ'


def parse_price(data):
    string = '%d. %s (%s) ‚Üí %.2f USD (%.2f%%) %s\n' % (data['rank'], data['name'], data['symbol'],
                                                       data['quotes']['USD']['price'], data['quotes']['USD']['percent_change_24h'], decide_emoji(
        data['quotes']['USD']['percent_change_24h']))
    return string


def parse_prices(data):
    string = ''
    for i in data['data']:
        string += parse_price(data['data'][i])
    string += '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: %s\n' % datetime.utcfromtimestamp(
        data['metadata']['timestamp'] + 10800).strftime('%H:%M')
    return string


def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º vk_api
    vk_session = vk_api.VkApi(token=os.environ['VK_TOKEN'])
    longpoll = VkBotLongPoll(vk_session, '174462552')
    vk = vk_session.get_api()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–≥–æ–¥–Ω—ã–π api
    owm = pyowm.OWM(os.environ['OWM_TOKEN'], language='ru')
    observation = owm.weather_at_id(524901)
    w = observation.get_weather()
    wind = w.get_wind()

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫—Ä–∏–ø—Ç—ã
    coinmarketcap = Market()
    data = coinmarketcap.ticker(
        start=0, limit=10, convert='USD')
    datatimestamp = 0

    # –õ–æ–≤–∏–º –≤—Å–µ –≤—ã—Ö–æ–¥—ã

    def exit_handler():
        vk.messages.send(
            chat_id=10, message='–•–ª–µ–±–æ—Ç: ' + '—è –≤—ã–∫–ª—é—á–∏–ª—Å—è –∏–ª–∏ –∫—Ä–∞—à–Ω—É–ª—Å—è')
    atexit.register(exit_handler)

    # –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å longpoll
    for event in longpoll.listen():
        print(event.obj.peer_id)
        if hasattr(event, 'type'):
            if event.type == VkBotEventType.MESSAGE_NEW:
                if (re.match(r'!—Ñ–ª–∏–ø', event.obj.text.lower())):
                    # –ö–∏–¥–∞–µ–º –º–æ–Ω–µ—Ç–∫—É
                    vk.messages.send(
                        peer_id=event.obj.peer_id, random_id=event.obj.random_id, message='–•–ª–µ–±–æ—Ç: ' + random.choice(['–û—Ä–µ–ª', '–†–µ—à–∫–∞']))
                elif (re.match(r'!–ø–æ–≥–æ–¥–∞', event.obj.text.lower())):
                    # –ë–µ—Ä–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ–π –ø–æ–≥–æ–¥—ã
                    ts = int(w.get_reference_time('unix'))
                    # –°–º–æ—Ç—Ä–∏–º –Ω–µ –ø—Ä–æ—à–ª–æ –ª–∏ –ø–æ–ª—á–∞—Å–∞
                    if (datetime.now().timestamp() - ts > 3600):
                        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É –∑–∞–Ω–æ–≤–æ –µ—Å–ª–∏ –¥–∞
                        observation = owm.weather_at_id(524901)
                        w = observation.get_weather()
                        wind = w.get_wind()
                        ts = int(w.get_reference_time('unix'))
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
                    vk.messages.send(peer_id=event.obj.peer_id, random_id=event.obj.random_id, message='–•–ª–µ–±–æ—Ç:\n–°–µ–π—á–∞—Å –≤ –ú–æ—Å–∫–≤–µ: %d¬∞C, %s\n–í–µ—Ç–µ—Ä: %s, %d–º/—Å–µ–∫\n–í–ª–∞–∂–Ω–æ—Å—Ç—å: %d%%\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: %s' % (
                        round(w.get_temperature('celsius')['temp']), w.get_detailed_status(), degree_to_text(wind['deg']), wind['speed'], w.get_humidity(), datetime.utcfromtimestamp(
                            ts + 10800).strftime('%H:%M')))
                elif (re.match(r'!–∫—É—Ä—Å', event.obj.text.lower())):
                    # –°–º–æ—Ç—Ä–∏–º –Ω–µ –ø—Ä–æ—à–ª–∏ –ª–∏ 5 –º–∏–Ω—É—Ç
                    if (datetime.now().timestamp() - datatimestamp > 60):
                        data = coinmarketcap.ticker(
                            start=0, limit=10, convert='USD')
                        datatimestamp = datetime.now().timestamp()
                        vk.messages.send(peer_id=event.obj.peer_id, random_id=event.obj.random_id, message='–•–ª–µ–±–æ—Ç:\n%s' % parse_prices(
                            data))
                    else:
                        vk.messages.send(
                            peer_id=event.obj.peer_id, random_id=event.obj.random_id, message='–•–ª–µ–±–æ—Ç: –∫–æ–º–∞–Ω–¥—É !–∫—É—Ä—Å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É')
                elif ((re.match(r'!–∫–æ–º–∞–Ω–¥—ã', event.obj.text.lower())) or (re.match(r'!–ø–æ–º–æ—â—å', event.obj.text.lower()))):
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã
                    vk.messages.send(
                        peer_id=event.obj.peer_id, random_id=event.obj.random_id, message='–ö–æ–º–∞–Ω–¥—ã –•–ª–µ–±–æ—Ç–∞:\n!–ø–æ–≥–æ–¥–∞ - –ü–æ–≥–¥–∞ –≤ –ú–æ—Å–∫–≤–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç\n!—Ñ–ª–∏–ø - –ø–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏–µ –º–æ–Ω–µ—Ç–∫–∏\n!–∫—É—Ä—Å - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ø-10 –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç\n!–ø–æ–º–æ—â—å –∏–ª–∏ !–∫–æ–º–∞–Ω–¥—ã - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è')


if __name__ == '__main__':
    main()
